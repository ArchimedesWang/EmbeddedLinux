# 综合 Project：**安全日志采集与管理服务（Mini Log Daemon）**

> **目标一句话**：
> 编写一个基于 *文件 I/O* 的日志采集程序，
> 正确处理 **文件创建 / 追加 / 删除 / 链接 / 目录 / 权限 / 并发语义**，
> 用来**检验你是否真正理解了 Unix 文件系统与文件 I/O 语义**。

---

## 一、项目定位（你在“验证什么”）

这个项目**不考算法、不考网络、不考多线程**，只考：

* 你是否真正理解：

  * `open / read / write / lseek`
  * `link / unlink / rename`
  * 文件偏移量的共享与不共享
  * 文件 vs 目录的语义差异
  * 权限、原子性、生命周期
* 你是否能**用正确的系统调用解决真实问题**

---

## 二、项目功能需求（必须全部覆盖）

### 1️⃣ 日志目录初始化（文件 & 目录）

程序启动时：

* 检查日志根目录是否存在

  * 不存在 → 创建
  * 已存在但不是目录 → 报错退出
* 检查日志文件是否存在

  * 不存在 → 创建
  * 已存在 → 追加写入

👉 **考点**：
`stat / mkdir / open(O_CREAT | O_APPEND)`
文件 vs 目录区分

---

### 2️⃣ 日志写入（重点：文件 I/O）

* 每次写入一条日志：

  * 带时间戳
  * 带进程 PID
* **必须使用 `write()`**
* **禁止使用 stdio（printf / fprintf）**

👉 **考点**：

* `write` 原子性
* 为什么 `O_APPEND` 很重要
* 为什么不用 `fopen`

---

### 3️⃣ 日志轮转（核心难点 ⭐⭐⭐）

当日志文件超过指定大小（比如 4KB）：

* 当前日志文件：

  * 原子地“变成历史文件”
* 新日志文件：

  * 从空文件开始

**要求**：

* 轮转过程中：

  * 不丢日志
  * 不出现半文件
* 不允许用 shell 命令

👉 **考点**（这是项目灵魂）：

* `stat` 获取大小
* `rename()` 的原子性
* 或 `link + unlink` 的语义
* “名字切换 ≠ 文件切换”

---

### 4️⃣ 硬链接备份（考 inode 理解）

在日志轮转后：

* 给“最新完整日志”创建一个 **硬链接备份**
* 验证：

  * 删除原文件后
  * 备份文件是否仍然存在

👉 **考点**：

* `link()`
* inode / link count
* “删除名字 ≠ 删除文件”

---

### 5️⃣ unlink 的正确使用场景（必考）

程序启动时：

* 主动 `unlink()` 一个临时日志文件名
* 再重新创建

👉 **考点**：

* 为什么 `unlink` 不关心文件是否存在
* 为什么 unlink 常用于“清理历史状态”

---

### 6️⃣ 文件偏移量验证（你刚学的重点）

在程序中设计一个测试逻辑：

* 同一个日志文件：

  * `open()` 两次
  * 分别写入
* 验证：

  * 是否共享偏移量
* 再用：

  * `dup()` 或 `fork()`
  * 验证共享偏移量

👉 **考点**：

* open file description
* fd vs 文件表 vs inode

---

## 三、禁止 & 强制规则（非常重要）

### ❌ 禁止

* `fopen / fprintf / fclose`
* `system()`
* shell 命令
* `rm / mv` 外部调用

### ✅ 强制

* 只能用：

  * `open / read / write / close`
  * `stat / fstat`
  * `link / unlink / rename`
  * `mkdir / rmdir`
* 所有错误：

  * 必须检查返回值
  * 用 `perror`

---



