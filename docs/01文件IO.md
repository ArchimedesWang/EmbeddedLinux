## 文件IO
> 均为**不带缓冲的`I/O`**，即每次调用都会触发一次系统调用 \
> 对于内核而言，所有打开的文件都通过**文件描述符**(非负整数)引用
``` 
fd 0 → stdin
fd 1 → stdout
fd 2 → stderr

shell中 重定向符号 
< 默认作用于标准输入（fd=0)
> 默认作用于标准输出（fd=1）
```
---
### 1. `open` 函数
```c
#include <fcntl.h>
int open (const char *__path, int __oflag, ...);
```
>`retuen` -1打开失败 否则文件描述符
- `O_WDNOLY` 只读
- `O_RDNOLY` 只写
- `O_RDWR`   读写

可追加

- `O_APPEND`
- `O_CREAT`
- `O_TRUNC`
---

### 2. `creat` 函数 
```c
#include <fcntl.h>
int creat (const char *__file, mode_t __mode);
```
>`retuen` -1创建失败 否则文件描述符

---
### 3. `close` 函数
```c
#include <unistd.h>
int close (int __fd);
```
>`retuen` -1关闭失败 0成功

---
### 4. `lseek` 函数
```c
#include <unistd.h>
__off_t lseek (int __fd, __off_t __offset, int __whence);
```
>`retuen` -1关闭失败 否则文件偏移量

`whence`
- `SEEK_SET` 距文件开始`offest`个字节
- `SEEK_CUR` 距文件当前`offest`个字节
- `SEEK_END` 文件长度`offest`个字节
---
### 5. `read` 函数
```c
#include <unistd.h>
read (int __fd, void *__buf, size_t __nbytes);
```
>`retuen` -1读失败 0读到文件尾 否则已读字节数

---
### 6. `write` 函数
```c
ssize_t write (int __fd, const void *__buf, size_t __n);
```

>`retuen` -1写失败 否则已写字节数
---
### 空洞实验
>文件系统以“块”为单位分配空间
如 ext4 ：
block size = 4KB

- 示例代码位于：[空洞实验](../code/01FileIO/1.c)

![alt text](./imgs/1.png)

---
### IO文件共享
`Linux` 通过进程**文件描述符表**、**文件表项**和**inode**三层结构实现文件共享语义：
- 当多个 `fd` 指向同一个文件表项时，它们共享文件状态和当前偏移量
- 当多个文件表项仅指向同一个 `inode` 时，虽然共享文件内容，但各自维护独立的偏移量，这在并发写场景下存在竞争风险

![alt text](./imgs/2.png)

**原子操作**：内核保证某个文件相关操作在并发环境下作为一个不可分割的整体执行，从而避免竞争条件
- `open()` 时的 `O_CREAT | O_TRUNC`
- `open()` 时的 `O_APPEND`
---
### 7. `dup`和`dup2`函数

```c
int dup (int __fd);
int dup2 (int __fd, int __fd2);
```
>`retuen` -1失败 否则返回新文件描述符

- 示例代码位于：[dup实验](../code/01FileIO/2.c)

![alt text](./imgs/3.png)

---
### 8. `fcntl`函数

```c
int fcntl (int __fd, int __cmd, ...);
```
>`retuen` -1失败 否则依赖于`cmd`

1. 复制一个现有的描述符
- `F_DUPFD`：复制文件描述符
- `F_DUPFD_CLOEXEC`：复制文件描述符，设置`FD_CLOEXEC`标志
2. 获得／设置文件状态标记
- `F_GETFL`：获取文件描述符的当前状态标志
- `F_SETFL`：设置文件描述符的状态标志
3. 获得／设置文件描述符标记
- `F_GETFD`：获取文件描述符的内部标志
- `F_SETFD`：设置文件描述符的内部标志

设置 `val |= flags`
清除 `val &= ~flags`

---


---